{"result":["SET \n  CURR_DATE = (\n    SELECT \n      CONVERT_TIMEZONE(\n        'Europe\/Prague', \n        current_timestamp()\n      )\n  ):: DATE;","SET \n  CURR_TIMESTAMP = (\n    SELECT \n      CONVERT_TIMEZONE(\n        'Europe\/Prague', \n        current_timestamp()\n      ):: TIMESTAMP_NTZ\n  );","SET \n  CURR_DATE_TXT = (\n    SELECT \n      TO_CHAR($CURR_DATE, 'YYYY-MM-DD')\n  );","SET \n  CURR_TIMESTAMP_TXT = (\n    SELECT \n      TO_CHAR(\n        $CURR_TIMESTAMP, 'YYYY-MM-DD HH:Mi:SS'\n      )\n  );","CREATE \nOR REPLACE TABLE changed_records_snapshot AS WITH diff_records AS (\n  SELECT \n    input.\"zipcode\", \n    input.\"usergender\", \n    input.\"usercity\" \n  FROM \n    \"in_table\" input MINUS \n  SELECT \n    snap.\"zipcode\", \n    snap.\"usergender\", \n    snap.\"usercity\" \n  FROM \n    \"curr_snapshot\" snap \n  WHERE \n    \"actual\" = 1\n) \nSELECT \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  $CURR_DATE_TXT AS \"start_date\", \n  '9999-12-31 00:00:00' AS \"end_date\", \n  1 AS \"actual\", \n  0 AS \"is_deleted\" \nFROM \n  diff_records;","CREATE \nOR REPLACE TABLE deleted_records_snapshot AS \nSELECT \n  snap.\"zipcode\", \n  snap.\"usergender\", \n  snap.\"usercity\", \n  snap.\"start_date\" AS \"start_date\", \n  9999 - 12 - 31 00 : 00 : 00 AS \"end_date\", \n  1 AS \"actual\", \n  1 AS \"is_deleted\" \nFROM \n  \"curr_snapshot\" snap \n  LEFT JOIN \"in_table\" input ON snap.\"zipcode\" = input.\"zipcode\" \nWHERE \n  snap.\"actual\" = 1 \n  AND input.\"zipcode\" IS NULL;","CREATE \nOR REPLACE TABLE updated_snapshots AS \nSELECT \n  snap.\"zipcode\", \n  snap.\"usergender\", \n  snap.\"usercity\", \n  snap.\"start_date\", \n  $CURR_DATE_TXT AS \"end_date\", \n  0 AS \"actual\", \n  0 AS \"is_deleted\" \nFROM \n  \"curr_snapshot\" snap \n  JOIN changed_records_snapshot input ON snap.\"zipcode\" = input.\"zipcode\" \nWHERE \n  snap.\"actual\" = 1;","CREATE \nOR REPLACE TABLE \"final_snapshot\" AS \nSELECT \n  \"zipcode\" || '|' || \"start_date\" AS \"snap_pk\", \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  \"start_date\", \n  \"end_date\", \n  \"actual\" \nFROM \n  deleted_records_snapshot \nUNION \nSELECT \n  \"zipcode\" || '|' || \"start_date\" AS \"snap_pk\", \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  \"start_date\", \n  \"end_date\", \n  \"actual\" \nFROM \n  updated_snapshots \nUNION \nSELECT \n  \"zipcode\" || '|' || \"start_date\" AS \"snap_pk\", \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  \"start_date\", \n  \"end_date\", \n  \"actual\" \nFROM \n  changed_records_snapshot;"]}