{"result":["SET \n  CURR_DATE = (\n    SELECT \n      CONVERT_TIMEZONE(\n        'Europe\/Prague', \n        current_timestamp()\n      )\n  ):: DATE;","SET \n  CURR_TIMESTAMP = (\n    SELECT \n      CONVERT_TIMEZONE(\n        'Europe\/Prague', \n        current_timestamp()\n      ):: TIMESTAMP_NTZ\n  );","SET \n  CURR_DATE_TXT = (\n    SELECT \n      TO_CHAR($CURR_DATE, 'YYYY-MM-DD')\n  );","SET \n  CURR_TIMESTAMP_TXT = (\n    SELECT \n      TO_CHAR(\n        $CURR_TIMESTAMP, 'YYYY-MM-DD HH:Mi:SS'\n      )\n  );","-- actual snapshot\nCREATE \nOR REPLACE TABLE records_snapshot AS \nSELECT \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  $CURR_TIMESTAMP_TXT AS \"snapshot_date\", \n  1 AS \"actual\", \n  0 AS \"is_deleted\" \nFROM \n  \"in_table\";","-- last snapshot rows to update actual flag\nCREATE \nOR REPLACE TABLE last_curr_records AS \nSELECT \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  \"snapshot_date\", \n  0 AS \"actual\" \nFROM \n  \"curr_snapshot\" \nWHERE \n  \"actual\" = 1;","CREATE \nOR REPLACE TABLE deleted_records_snapshot AS \nSELECT \n  snap.\"zipcode\", \n  snap.\"usergender\", \n  snap.\"usercity\", \n  $CURR_TIMESTAMP_TXT AS \"snapshot_date\", \n  1 AS \"actual\", \n  1 AS \"is_deleted\" \nFROM \n  \"curr_snapshot\" snap \n  LEFT JOIN \"in_table\" INPUT ON snap.\"id\" = input.\"ID\" \nWHERE \n  snap.\"actual\" = 1 \n  AND input.\"ID\" IS NULL;","-- final snapshot table\nCREATE \nOR REPLACE TABLE \"final_snapshot\" AS \nSELECT \n  \"zipcode\" || '|' || \"snapshot_date\" AS \"snap_pk\", \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  \"snapshot_date\", \n  \"actual\" \nFROM \n  last_curr_records \nUNION \nSELECT \n  \"zipcode\" || '|' || \"snapshot_date\" AS \"snap_pk\", \n  \"zipcode\", \n  \"usergender\", \n  \"usercity\", \n  \"snapshot_date\", \n  \"actual\" \nFROM \n  records_snapshot;"]}